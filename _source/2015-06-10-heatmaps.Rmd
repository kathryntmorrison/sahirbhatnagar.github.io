---
title: "Heatmaps in R"
author: "sahir"
date: "June 10, 2015"
output: html_document
layout: post
tags: [R, heatmap, gene expression]
permalink: heatmap
comments: yes
---

```{r setup, echo=FALSE, message=FALSE,warning=FALSE}
library(knitr)
opts_chunk$set(tidy = TRUE, warning = FALSE, message = FALSE)
opts_template$set(
    fig.large = list(fig.width = 7, fig.height = 5, fig.align = 'center', fig.pos = 'h'),
    fig.small = list(fig.width = 6, fig.height = 4, fig.align = 'center', fig.pos = 'h'),
    fig.full = list(fig.width = 9, fig.height = 7, fig.align = 'center', fig.pos = 'h')
)
knit_hooks$set(crop = hook_pdfcrop)
```


In every statistical analysis, the first thing one should do is try and visualise the data before any modeling. In microarray studies, a common visualisation is a heatmap of gene expression data. In this post I simulate some gene expression data and visualise it using the `pheatmap` function from the [pheatmap](http://cran.r-project.org/web/packages/pheatmap/) package in `R`. You will also need the `mvrnorm` function from the [MASS](http://cran.r-project.org/web/packages/MASS/index.html) library to simulate from a multivariate normal distribution, and the `brewer.pal` function from the [RColorBrewer](http://cran.r-project.org/web/packages/RColorBrewer/index.html) library for easier customization of colors. 

<!--more-->

First I simulate some gene expression data for genes which are correlated conditional on an exposure status:
```{r,tidy=FALSE}
# Initiate Simulation parameters
  n = 100       # total number of subjects
  n0 = 50       # number of subjects with X=0
  n1 = n - n0   # number of subjects with X=1
  p = 100       # number of genes
  times = 1:p   # used for creating covariance matrix
  rho.0 = 0.01  # rho between Z_i and Z_j when X=0
  rho.1 = 0.95  # rho between Z_i and Z_j when X=1
  sigma = 1
  
# Simulate gene expression values according to exposure X=0, X=1, according to a centered multivariate normal distribution with covariance between Z_i and Z_j being rho^|i-j|
  H <- abs(outer(times, times, "-"))
  V0 <- sigma * rho.0^H
  V1 <- sigma * rho.1^H

  # rows are people, columns are genes
  genes0 <- MASS::mvrnorm(n = n0, mu = rep(0,p), Sigma = V0)
  genes1 <- MASS::mvrnorm(n = n1, mu = rep(0,p), Sigma = V1)
  genes <- rbind(genes0,genes1)
  dim(genes)
```

In order to properly label the heatmap, we must label the matrix of gene expressions:
```{r,tidy=TRUE}
  colnames(genes) <- paste0("Gene", 1:p)
  rownames(genes) <- paste0("Subject",1:n)
  genes[1:5,1:5]
```

Because we want to clearly identify the subjects who were exposed and not exposed on the heatmap, we first need to create a separate data frame which contains that information. This data frame can contain many columns, but in this example we only want to annotate the exposure status. Note that the rownames of this data frame need to correspond to the rownames in the gene expression data created above:
```{r, tidy=FALSE}
library(magrittr) # for piping operator

annotation_col <- rep("X=0",n0) %>% 
                  c(rep("X=1", n1)) %>% 
                  factor %>% 
                  data.frame

colnames(annotation_col) <- "Exposure"

rownames(annotation_col) = paste0("Subject", 1:n)
annotation_col %>% head
```

To see the palettes available for coloring the heatmap:
```{r, crop = TRUE, opts.label = 'fig.full'}
RColorBrewer::display.brewer.all()
```

The pheatmap comes with lots of customizations (see the [help page](http://cran.r-project.org/web/packages/pheatmap/pheatmap.pdf) for a complete list of options). In this example I don't want to perform any clustering and I want a gap between the exposed and unexposed. Note that we must pass the transpose of the matrix for the `pheatmap` function, which is not the case for other functions such as `gplots::heatmap.2`.
```{r, crop = TRUE, opts.label = 'fig.full', tidy=FALSE}
col.pal <- RColorBrewer::brewer.pal(9,"Reds")

pheatmap::pheatmap(t(genes), 
                   cluster_row=F,
                   annotation_col = annotation_col, 
                   color = col.pal, 
                   cluster_cols = F,
                   gaps_col=50)
```




